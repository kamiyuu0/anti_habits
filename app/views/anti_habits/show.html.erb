<div class="container mx-auto px-4 py-6">
  <!-- メイン投稿 -->
  <div class="card bg-base-100 shadow-xl rounded-2xl border border-base-300 mb-8">
    <div class="card-body p-8">
      <!-- ユーザー情報 -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center">
            <i class="fas fa-user text-lg mr-3"></i>
            <div>
              <h3 class="font-semibold text-lg"><%= @anti_habit.user.name %></h3>
            </div>
        </div>

        <!-- 本人マーク・非公開バッジ -->
        <div class="flex gap-2">
          <% if current_user == @anti_habit.user %>
            <div class="badge badge-info text-[8px] sm:text-sm">
              あなたの投稿
            </div>
            <% if !@anti_habit.is_public %>
              <div class="badge badge-warning text-[8px] sm:text-sm">
                非公開
              </div>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- タイトル -->
      <div class="mb-6">
        <h1 class="text-3xl font-bold mb-2">
          <%= @anti_habit.title %>
        </h1>

        <div class="flex flex-wrap gap-2">
          <div class="badge badge-success badge-lg">
            連続<%= @anti_habit.consecutive_days_achieved %>日達成！
          </div>

          <% if @anti_habit.goal_days.present? %>
            <div class="badge badge-outline badge-lg">
              目標：<%= @anti_habit.goal_days %>日
            </div>
          <% end %>

          <% if @anti_habit.goal_achieved? %>
            <div class="badge badge-warning badge-lg flex items-center gap-1">
              <i class="fas fa-trophy text-sm"></i>
              目標達成
            </div>
          <% end %>
        </div>
      </div>

      <!-- ヒートマップセクション（本人のみ、PCのみ表示） -->
      <% if current_user&.own?(@anti_habit) && @calendar_data.present? %>
        <div class="mb-6 hidden md:block">
          <div class="card bg-base-100 border border-base-300 rounded-lg">
            <div class="card-body p-4 sm:p-6">
              <h2 class="card-title text-lg sm:text-xl mb-4">
                <i class="fas fa-calendar-check mr-2"></i>
                活動記録（過去3ヶ月間）
              </h2>
              <%
                start_date = (Time.zone.today - 89.days).to_s
                end_date = Time.zone.today.to_s
              %>
              <%= calendar_chart @calendar_data,
                height: '180px',
                options: {
                  tooltip: {
                    position: 'top',
                    formatter: RailsCharts.js("(params) => params.data[0]")
                  },
                  visualMap: {
                    show: false,
                    min: 0,
                    max: 1,
                    inRange: {
                      color: ['#ebedf0', '#216e39']
                    }
                  },
                  calendar: {
                    top: 30,
                    left: 'center',
                    right: 10,
                    cellSize: ['auto', 13],
                    range: [start_date, end_date],
                    itemStyle: {
                      borderWidth: 3,
                      borderColor: '#fff'
                    },
                    yearLabel: {
                      show: false
                    },
                    monthLabel: {
                      nameMap: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                      fontSize: 10
                    },
                    dayLabel: {
                      firstDay: 1,
                      nameMap: ['日', '月', '火', '水', '木', '金', '土'],
                      fontSize: 10
                    },
                    splitLine: {
                      show: true,
                      lineStyle: {
                        color: '#f0f0f0',
                        width: 1
                      }
                    }
                  }
                }
              %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- 説明 -->
      <div class="mb-6">
        <div class="prose max-w-none">
          <p class="text-base-content/80 leading-relaxed whitespace-pre-wrap"><%= @anti_habit.description %></p>
        </div>
      </div>

      <!-- タグ -->
      <% if @anti_habit.tags.any? %>
        <div class="mb-6">
          <div class="flex flex-wrap gap-2">
            <% @anti_habit.tags.each do |tag| %>
              <div class="badge badge-outline badge-primary">
                <%= link_to anti_habits_path(q: { tags_name_in: tag.name }) do %>
                  #<%= tag.name %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- 記録トグル（本人のみ） -->
      <% if current_user&.own?(@anti_habit) %>
        <div class="mb-6">
          <div class="text-center mb-4">
            <span class="text-lg font-medium">今日の記録：</span>
          </div>
          
          <div class="flex flex-col space-y-4">
            <% if @today_record %>
              <!-- 記録済みの状態 -->
              <div class="alert alert-success flex flex-col items-center justify-center text-center">
                <div class="flex items-center space-x-2">
                  <span class="text-2xl">💪</span>
                  <span class="font-bold text-lg">我慢できた</span>
                </div>
                <%= button_to "記録を削除", anti_habit_record_path(@today_record), 
                      method: :delete, 
                      data: { turbo_confirm: "記録を削除しますか？" },
                      class: "btn btn-neutral btn-sm mt-3" %>
              </div>
            <% else %>
              <!-- 我慢できたボタン -->
              <div class="card bg-success/10 border border-success/20 hover:bg-success/20 transition-colors cursor-pointer">
                <%= button_to anti_habit_records_path, 
                      params: { anti_habit_id: @anti_habit.id },
                      class: "w-full bg-transparent border-none p-0" do %>
                  <div class="card-body flex items-center justify-center p-6">
                    <div class="flex items-center space-x-2">
                      <span class="text-2xl">💪</span>
                      <span class="font-bold text-lg text-success">我慢できた</span>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- 編集・削除ボタン -->
        <div class="card-actions justify-end">
          <%# マジックナンバー後で修正 %>
          <% if current_user.provider == "line" %>
            <%= link_to "LINE通知設定", @anti_habit.notification_setting.present? ? edit_anti_habit_notification_setting_path(@anti_habit) : new_anti_habit_notification_setting_path(@anti_habit), class: "btn btn-outline btn-primary" %>
          <% else %>
            <!-- Open the modal using ID.showModal() method -->
            <button class="btn btn-outline btn-primary" onclick="my_modal_2.showModal()">LINE通知設定</button>
            <dialog id="my_modal_2" class="modal">
              <div class="modal-box">
                <p class="py-4">LINE通知にするにはLINE認証してください。</p>
                <%= button_to "LINEで認証",
                  user_line_omniauth_authorize_path,
                  method: :post,
                  class: "btn btn-success btn-sm w-full",
                  data: { turbo: false } %>
              </div>
              <form method="dialog" class="modal-backdrop">
                <button></button>
              </form>
            </dialog>
          <% end %>
          <% if @anti_habit.is_public %>
            <%= link_to "Xでシェアする",
                        "https://twitter.com/intent/tweet?url=#{root_url}anti_habits/#{@anti_habit.id}&text=#{CGI.escape("Anti Habitsで悪習慣を登録！")}%0A#{CGI.escape("悪習慣を辞められるか監視してください！")}\n&hashtags=#{CGI.escape("AntiHabits")}",
                        target: "_blank",
                        rel: "noopener noreferrer",
                        class: "btn btn-outline btn-neutral" %>
          <% end %>
          <%= link_to "編集", edit_anti_habit_path(@anti_habit), class: "btn btn-outline btn-primary" %>
          <%= link_to "削除", anti_habit_path(@anti_habit),
                data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
                class: "btn btn-outline btn-error" %>
        </div>
      <% end %>

      <!-- リアクションボタン（公開時のみ表示） -->
      <% if user_signed_in? && @anti_habit.is_public %>
        <div class="flex items-center mt-4 space-x-4">
          <%= render "shared/reaction_button", anti_habit: @anti_habit %>
          <div class="flex items-center space-x-1">
            <i class="fas fa-comment"></i>
            <span id="comments-count"><%= @anti_habit.comments_count %></span>件
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- コメントセクション（公開かつログイン時のみ表示） -->
  <% if user_signed_in? && @anti_habit.is_public %>
    <div class="card bg-base-100 shadow-xl rounded-2xl border border-base-300">
      <div class="card-body p-8">
        <h2 class="card-title text-2xl mb-6">
          応援メッセージ
          <div class="badge badge-neutral">
            <span id="comments-count2"><%= @anti_habit.comments_count %></span>件
          </div>
        </h2>

        <!-- 新規コメントフォーム -->
        <div class="mb-6">
          <%= render "comments/form", comment: Comment.new, anti_habit: @anti_habit %>
        </div>

        <!-- 既存コメント一覧 -->
        <div class="space-y-4">
          <div id="comments-list">
            <% if @comments.any? %>
              <%= render @comments %>
            <% else %>
              <div class="hero min-h-32">
                <div class="hero-content text-center">
                  <div>
                    <p class="text-base-content/60 mb-2">
                      まだ応援メッセージはありません
                    </p>
                    <p class="text-base-content/60 text-sm">
                      最初の応援メッセージを投稿してみませんか？
                    </p>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>