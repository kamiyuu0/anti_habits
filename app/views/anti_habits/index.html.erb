<div class="container mx-auto px-4 py-6">
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-center mb-4">悪習慣一覧</h1>
    <p class="text-center text-base-content/70">みんなが克服したい悪習慣を見てみましょう</p>
  </div>

  <!-- 検索フォーム -->
  <div class="mb-6">
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body">
        <%= search_form_for @q, url: anti_habits_path, method: :get, class: "space-y-4" do |f| %>
          <div class="relative" 
               data-controller="autocomplete" 
               data-autocomplete-url-value="<%= autocomplete_anti_habits_path %>" 
               data-autocomplete-min-length-value="1" 
               role="combobox">
            <div class="join w-full">
              <%= f.search_field :title_or_description_cont,
                  placeholder: "タイトルか説明文で検索...",
                  class: "input input-bordered join-item w-full",
                  value: params.dig(:q, :title_or_description_cont),
                  data: { 
                    autocomplete_target: "input",
                    action: "input->autocomplete#onInput keydown->autocomplete#onKeydown blur->autocomplete#onBlur"
                  },
                  autocomplete: "off" %>
              <%= f.submit "検索", class: "btn btn-primary join-item" %>
            </div>
            <ul class="list-group absolute z-10 w-full top-full mt-1 max-h-60 overflow-y-auto bg-base-100 shadow-lg rounded-lg border border-base-300" 
                data-autocomplete-target="results" 
                data-action="click->autocomplete#selectOption"
                hidden></ul>
          </div>
          <div class="mt-4">
            <%= f.label :tags_name_in, "タグで絞り込み", class: "label-text mb-2 block" %>
            <%= f.select :tags_name_in, 
                        options_for_select([["指定なし", ""]] + @all_tags.map { |tag| [tag.name, tag.name] }, params.dig(:q, :tags_name_in)), 
                        { include_blank: false },
                        { class: "select select-bordered w-full" } %>
          </div>
          <% if params[:q].present? %>
            <div class="mt-2 text-center">
              <%= link_to "検索をクリア", anti_habits_path, class: "btn btn-sm btn-ghost" %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 週間達成ランキング -->
  <% if @top_weekly_achievers.present? %>
    <div class="mb-8">
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-2xl mb-4">
            🏆 週間達成ランキング TOP3
          </h2>
          <div class="space-y-4">
            <% @top_weekly_achievers.each do |rank_data| %>
              <% rank_data[:anti_habits].each do |anti_habit| %>
                <div class="flex items-center gap-4 p-4 bg-base-200 rounded-lg hover:bg-base-300 transition-colors">
                  <!-- ランキング順位 -->
                  <div class="flex-shrink-0">
                    <% case rank_data[:rank] %>
                    <% when 1 %>
                      <span class="text-4xl">🥇</span>
                    <% when 2 %>
                      <span class="text-4xl">🥈</span>
                    <% when 3 %>
                      <span class="text-4xl">🥉</span>
                    <% end %>
                  </div>

                  <!-- 悪習慣情報 -->
                  <div class="flex-grow">
                    <%= link_to anti_habit_path(anti_habit), class: "hover:underline" do %>
                      <h3 class="font-bold text-lg"><%= anti_habit.title %></h3>
                    <% end %>
                    <p class="text-sm text-base-content/70">
                      <%= anti_habit.user.name %>さん
                    </p>
                  </div>

                  <!-- 週間達成日数 -->
                  <div class="flex-shrink-0 text-right">
                    <div class="stat-value text-3xl text-primary">
                      <%= rank_data[:weekly_days] %>
                    </div>
                    <div class="stat-desc">日達成 / 今週</div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- 悪習慣一覧 -->
  <div class="space-y-6">
    <% if @anti_habits.any? %>
      <% @anti_habits.each do |anti_habit| %>
        <%= render 'anti_habit', anti_habit: anti_habit %>
      <% end %>
    <% else %>
      <!-- 空の状態 -->
      <div class="hero min-h-96">
        <div class="hero-content text-center">
          <div class="max-w-md">
            <div class="mb-6">
              <svg class="mx-auto w-24 h-24 text-base-content/30" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </div>
            <h3 class="text-2xl font-bold mb-4">
              <% if params[:q].present? %>
                検索結果が見つかりませんでした
              <% else %>
                まだ悪習慣が投稿されていません
              <% end %>
            </h3>
            <p class="mb-6">
              <% if params[:q].present? %>
                検索条件を変更して再度お試しください
              <% else %>
                最初の悪習慣を登録して、目標達成への第一歩を踏み出しましょう
              <% end %>
            </p>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- ページネーション -->
  <%= paginate @anti_habits %>
</div>